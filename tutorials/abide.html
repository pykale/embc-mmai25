
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Reducing Phenotypic Effects to Improve Multi-site Autism Classification Performance &#8212; PyKale</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/abide';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Preparation" href="../workshops/ukomain2025/preparation.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="PyKale - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="PyKale - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Overview
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Workshops</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../workshops/embc2025/intro.html">EMBC 2025 Workshop</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../workshops/embc2025/aims.html">Aims</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workshops/embc2025/synopsis.html">Synopsis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workshops/embc2025/schedule.html">Schedule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workshops/embc2025/preparation.html">Preparation</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../workshops/ukomain2025/intro.html">Multimodal AI Workshop 2025</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../workshops/ukomain2025/aims.html">Aims</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workshops/ukomain2025/synopsis.html">Synopsis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workshops/ukomain2025/schedule.html">Schedule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workshops/ukomain2025/preparation.html">Preparation</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Reducing Phenotypic Effects to Improve Multi-site Autism Classification Performance</a></li>


</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/pykale/embc-mmai25/main?urlpath=tree/tutorials/abide.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/pykale/embc-mmai25/blob/main/tutorials/abide.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/pykale/embc-mmai25" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/pykale/embc-mmai25/issues/new?title=Issue%20on%20page%20%2Ftutorials/abide.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/tutorials/abide.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Reducing Phenotypic Effects to Improve Multi-site Autism Classification Performance</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Reducing Phenotypic Effects to Improve Multi-site Autism Classification Performance</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#packages">Packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions">Helper Functions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-extraction">Feature Extraction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#trainer">Trainer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluation">Evaluation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization">Visualization</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pipeline">Pipeline</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resting-state-fmri-preprocessing">Resting-state fMRI Preprocessing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#phenotype-preprocessing">Phenotype Preprocessing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Feature Extraction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modeling">Modeling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-seed">Random Seed</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-validation-split">Cross-Validation Split</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-definition">Model Definition</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-and-cross-validation">Training and Cross-Validation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Evaluation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpretation">Interpretation</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="reducing-phenotypic-effects-to-improve-multi-site-autism-classification-performance">
<h1>Reducing Phenotypic Effects to Improve Multi-site Autism Classification Performance<a class="headerlink" href="#reducing-phenotypic-effects-to-improve-multi-site-autism-classification-performance" title="Link to this heading">#</a></h1>
<p>In this tutorial, we demonstrate how to leverage <strong>patient phenotypic information</strong> to reduce <strong>site-specific biases</strong> in functional connectivity data using <strong>domain adaptation</strong>, with the goal of improving <strong>multi-site autism classification</strong>.</p>
<p>This notebook builds on the work of <strong>Kunda et al. (IEEE TMI, 2022)</strong>, which introduced a second-order functional connectivity representation called <strong>Tangent-Pearson</strong>, the tangent embedding of the Pearson correlation matrix. The original work also applied domain adaptation to reduce site dependencies in fMRI-derived features, using <strong>site labels</strong> as the domain information.</p>
<p>We extend this approach by incorporating a <strong>richer set</strong> of phenotypic variables, such as sex, handedness, age, and eye status into the domain adaptation framework. This enables more effective harmonization across data collected from different imaging sites.</p>
<hr class="docutils" />
<p><strong>Objectives</strong></p>
<ol class="arabic simple">
<li><p><strong>Load</strong> the ABIDE dataset using different preprocessing pipelines and brain atlases.</p></li>
<li><p><strong>Extract</strong> functional connectivity features from ROI-based time series.</p></li>
<li><p><strong>Preprocess</strong> phenotypic variables for use in domain adaptation, and obtain class labels (ASD vs CONTROL) and site labels.</p></li>
<li><p><strong>Build</strong> a training and evaluation pipeline to assess classification performance under various domain adaptation strategies.</p></li>
<li><p><strong>Interpret</strong> the learned model by extracting weights for pairwise ROI feature importance and visualizing them using a connectome plot.</p></li>
</ol>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="setup">
<h1>Setup<a class="headerlink" href="#setup" title="Link to this heading">#</a></h1>
<p>As a starting point, we will install the required packages and load a set of helper functions to assist throughout this tutorial. To keep the output clean and focused on interpretation, we will also suppress warnings.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYTHONWARNINGS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ignore&quot;</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="packages">
<h2>Packages<a class="headerlink" href="#packages" title="Link to this heading">#</a></h2>
<p>The main packages required for this tutorial are PyKale and Nilearn.</p>
<p><strong>PyKale</strong> is an open-source interdisciplinary machine learning library developed at the University of Sheffield, with a focus on applications in biomedical and scientific domains.</p>
<p><strong>Nilearn</strong> is a Python library for neuroimaging analysis, widely used for processing and visualizing functional MRI (fMRI) data.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">quiet</span> <span class="n">git</span><span class="o">+</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">pykale</span><span class="o">/</span><span class="n">pykale</span><span class="nd">@main</span> <span class="n">nilearn</span> \
    <span class="o">&amp;&amp;</span> <span class="n">echo</span> <span class="s2">&quot;PyKale and Nilearn installed successfully ✅&quot;</span> \
    <span class="o">||</span> <span class="n">echo</span> <span class="s2">&quot;Failed to install PyKale and Nilearn ❌&quot;</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PyKale and Nilearn installed successfully ✅
</pre></div>
</div>
</div>
</div>
</section>
<section id="helper-functions">
<h2>Helper Functions<a class="headerlink" href="#helper-functions" title="Link to this heading">#</a></h2>
<p>The helper functions used in this tutorial are adapted from the <a class="reference external" href="https://github.com/zaRizk7/abide-demo">source code</a>, which was originally developed to demonstrate the use of containers for improving reproducibility and reusability in machine learning experiments.</p>
<section id="feature-extraction">
<h3>Feature Extraction<a class="headerlink" href="#feature-extraction" title="Link to this heading">#</a></h3>
<p>Includes functionality for:</p>
<ul class="simple">
<li><p><strong>Imputation</strong> of missing phenotypic values,</p></li>
<li><p><strong>Categorical encoding</strong> of variables such as sex, handedness, and eye status,</p></li>
<li><p><strong>Standardization</strong> of continuous features like age and FIQ,</p></li>
<li><p><strong>Chaining functional connectivity transformations</strong> (e.g., Pearson, Tangent) to extract features from ROI-based time series.</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nilearn.connectome</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConnectivityMeasure</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils._param_validation</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Integral</span><span class="p">,</span>
    <span class="n">Interval</span><span class="p">,</span>
    <span class="n">StrOptions</span><span class="p">,</span>
    <span class="n">validate_params</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">SELECTED_PHENOTYPES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;SUB_ID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SITE_ID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SEX&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AGE_AT_SCAN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FIQ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HANDEDNESS_CATEGORY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EYE_STATUS_AT_SCAN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DX_GROUP&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">MAPPING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;SEX&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;MALE&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;FEMALE&quot;</span><span class="p">},</span>
    <span class="s2">&quot;HANDEDNESS_CATEGORY&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="s2">&quot;LEFT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="s2">&quot;RIGHT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Mixed&quot;</span><span class="p">:</span> <span class="s2">&quot;AMBIDEXTROUS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Ambi&quot;</span><span class="p">:</span> <span class="s2">&quot;AMBIDEXTROUS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;L-&gt;R&quot;</span><span class="p">:</span> <span class="s2">&quot;AMBIDEXTROUS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;R-&gt;L&quot;</span><span class="p">:</span> <span class="s2">&quot;AMBIDEXTROUS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-9999&quot;</span><span class="p">:</span> <span class="s2">&quot;LEFT&quot;</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span> <span class="s2">&quot;LEFT&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;EYE_STATUS_AT_SCAN&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">},</span>
    <span class="s2">&quot;DX_GROUP&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;ASD&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;CONTROL&quot;</span><span class="p">},</span>
<span class="p">}</span>

<span class="n">AVAILABLE_FC_MEASURES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;pearson&quot;</span><span class="p">:</span> <span class="s2">&quot;correlation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;partial&quot;</span><span class="p">:</span> <span class="s2">&quot;partial correlation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tangent&quot;</span><span class="p">:</span> <span class="s2">&quot;tangent&quot;</span><span class="p">,</span>
    <span class="s2">&quot;covariance&quot;</span><span class="p">:</span> <span class="s2">&quot;covariance&quot;</span><span class="p">,</span>
    <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="nd">@validate_params</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
        <span class="s2">&quot;standardize&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">StrOptions</span><span class="p">({</span><span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">}),</span> <span class="s2">&quot;boolean&quot;</span><span class="p">],</span>
        <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">prefer_skip_nested_validation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_phenotypic_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process phenotypic data to impute missing values and and encode categorical</span>
<span class="sd">    variables including sex, handedness, eye status at scan, and diagnostic group.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : pd.DataFrame of shape (n_subjects, n_phenotypes)</span>
<span class="sd">        The phenotypes data to be processed.</span>

<span class="sd">    standardize: boolean or str of (&quot;site&quot;, &quot;all&quot;)</span>
<span class="sd">                Standardize FIQ and age. The default is 0.</span>
<span class="sd">                Setting to True or &quot;all&quot; standardizes the</span>
<span class="sd">                values over all subjects while &quot;site&quot;</span>
<span class="sd">                standardizes according to the site.</span>

<span class="sd">    verbose : int, optional</span>
<span class="sd">            The verbosity level. The default is 0.</span>
<span class="sd">            verbose &gt; 0 will log the current processing step.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    labels : pd.Series of shape (n_subjects)</span>
<span class="sd">            The encoded classification group. 0 is &quot;CONTROL&quot; and</span>
<span class="sd">            1 is &quot;ASD&quot;</span>

<span class="sd">    phenotypes : pd.DataFrame of shape (n_subjects, n_selected_phenotypes)</span>
<span class="sd">                The processed selected phenotype data with imputed values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;feature_extraction.process_phenotypic_data&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Imputing missing values and encoding handedness...&quot;</span><span class="p">)</span>

    <span class="c1"># Avoid in-place modification</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Check for missing values, either -9999 or NaN</span>
    <span class="c1"># and impute them with FIQ = 100 following original code.</span>
    <span class="n">fiq</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;FIQ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;FIQ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fiq</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">fiq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">9999</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fiq</span><span class="p">)),</span> <span class="mi">100</span><span class="p">)</span>

    <span class="c1"># Standardize FIQ and age by site</span>
    <span class="k">if</span> <span class="n">standardize</span> <span class="o">==</span> <span class="s2">&quot;site&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;SITE_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">site</span> <span class="o">==</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;SITE_ID&quot;</span><span class="p">]</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;AGE_AT_SCAN&quot;</span><span class="p">,</span> <span class="s2">&quot;FIQ&quot;</span><span class="p">]]</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;AGE_AT_SCAN&quot;</span><span class="p">,</span> <span class="s2">&quot;FIQ&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">values</span>
    <span class="k">elif</span> <span class="n">standardize</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;AGE_AT_SCAN&quot;</span><span class="p">,</span> <span class="s2">&quot;FIQ&quot;</span><span class="p">]]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;AGE_AT_SCAN&quot;</span><span class="p">,</span> <span class="s2">&quot;FIQ&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">values</span>

    <span class="c1"># Encode categorical variables to be more explicit categorical</span>
    <span class="c1"># values. For handedness, if we found missing values, we</span>
    <span class="c1"># impute them by using &#39;LEFT&#39; as default. Values</span>
    <span class="c1"># like &#39;Ambi&#39;, &#39;Mixed&#39;, &#39;L-&gt;R&#39;, and &#39;R-&gt;L&#39; are mapped to</span>
    <span class="c1"># &#39;AMBIDEXTROUS&#39;. The rest of the values are mapped to &#39;LEFT&#39; or &#39;RIGHT&#39;</span>
    <span class="c1"># for &#39;L&#39; or &#39;R&#39; respectively.</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">MAPPING</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">MAPPING</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>

    <span class="c1"># Subsets the phenotypes</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">SELECTED_PHENOTYPES</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;SUB_ID&quot;</span><span class="p">)</span>

    <span class="c1"># Separate the class labels, sites, and phenotypes</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;DX_GROUP&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="s2">&quot;CONTROL&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ASD&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
    <span class="n">sites</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;SITE_ID&quot;</span><span class="p">]</span>
    <span class="n">phenotypes</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DX_GROUP&quot;</span><span class="p">])</span>
    <span class="c1"># One-hot encode categorical valued phenotypes</span>
    <span class="n">phenotypes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">phenotypes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Imputation and encoding completed.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">labels</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">phenotypes</span>


<span class="nd">@validate_params</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;array-like&quot;</span><span class="p">],</span>
        <span class="s2">&quot;measures&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">list</span><span class="p">],</span>
        <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">prefer_skip_nested_validation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_functional_connectivity</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pearson&quot;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract functional connectivity features from time series data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : list[array-like] of shape (n_subjects,)</span>
<span class="sd">        An array of numpy arrays, where each array is a time series of shape (t, n_rois).</span>
<span class="sd">        The time series data for each subject.</span>

<span class="sd">    measures : list[str], optional</span>
<span class="sd">        A list of connectivity measures to use for feature extraction.</span>
<span class="sd">        The default is [&quot;pearson&quot;].</span>
<span class="sd">        Supported measures are &quot;pearson&quot;, &quot;partial&quot;, &quot;tangent&quot;, &quot;covariance&quot;, and &quot;precision&quot;.</span>
<span class="sd">        Multiple measures can be specified as a list to compose a higher-order measure.</span>

<span class="sd">    verbose : int, optional</span>
<span class="sd">        The verbosity level. The default is 0.</span>
<span class="sd">        verbose &gt; 0 will log the current processing step.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    features : array-like</span>
<span class="sd">        An array of shape (n_subjects, n_features) containing the extracted features.</span>
<span class="sd">        n_features is equal to `n_rois * (n_rois - 1) / 2` for each subjects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;feature_extraction.extract_functional_connectivity&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracting functional connectivity features...&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using measures: </span><span class="si">{</span><span class="n">measures</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">measures</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">AVAILABLE_FC_MEASURES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="c1"># If it is the last transformation, vectorize and discard the diagonal</span>
        <span class="c1"># of shape (n_rois * (n_rois - 1) / 2)</span>
        <span class="n">islast</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">measures</span><span class="p">)</span>
        <span class="n">measure</span> <span class="o">=</span> <span class="n">ConnectivityMeasure</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">vectorize</span><span class="o">=</span><span class="n">islast</span><span class="p">,</span> <span class="n">discard_diagonal</span><span class="o">=</span><span class="n">islast</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Functional connectivity features extracted.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="trainer">
<h3>Trainer<a class="headerlink" href="#trainer" title="Link to this heading">#</a></h3>
<p>Defines the <strong>hyperparameter search spac</strong>e and provides a <strong>wrapper function</strong> to train the classification pipeline, with or without domain adaptation.</p>
<p>Providing various search strategies (e.g., grid or randomized search) and integrates seamlessly with cross-validation and MIDA-based feature transformation when enabled.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">kale.pipeline.mida_trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">MIDATrainer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">clone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.dummy</span><span class="w"> </span><span class="kn">import</span> <span class="n">DummyClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">RidgeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_scorer_names</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">RandomizedSearchCV</span><span class="p">,</span> <span class="n">check_cv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearSVC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils._param_validation</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Integral</span><span class="p">,</span>
    <span class="n">Interval</span><span class="p">,</span>
    <span class="n">StrOptions</span><span class="p">,</span>
    <span class="n">validate_params</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;create_trainer&quot;</span><span class="p">]</span>

<span class="c1"># Inverse regularization coefficients for the classifiers</span>
<span class="c1"># For Ridge (alpha) and MIDA (mu and eta), we use 1 / (2C)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">start</span><span class="o">=-</span><span class="mi">15</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">30</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">CLASSIFIER</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;logistic&quot;</span><span class="p">:</span> <span class="n">LogisticRegression</span><span class="p">(),</span>
    <span class="s2">&quot;svm&quot;</span><span class="p">:</span> <span class="n">LinearSVC</span><span class="p">(),</span>
    <span class="s2">&quot;ridge&quot;</span><span class="p">:</span> <span class="n">RidgeClassifier</span><span class="p">(),</span>
<span class="p">}</span>

<span class="n">CLASSIFIER_GRID</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;logistic&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">C</span><span class="p">},</span>
    <span class="s2">&quot;svm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">C</span><span class="p">},</span>
    <span class="s2">&quot;ridge&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">C</span><span class="p">)},</span>
<span class="p">}</span>

<span class="n">MIDA_GRID</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;num_components&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="s2">&quot;mu&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">C</span><span class="p">),</span>
    <span class="s2">&quot;eta&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">C</span><span class="p">),</span>
    <span class="s2">&quot;ignore_y&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">MIDA_GRID</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;domain_adapter__</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">MIDA_GRID</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


<span class="nd">@validate_params</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;classifier&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">StrOptions</span><span class="p">({</span><span class="s2">&quot;logistic&quot;</span><span class="p">,</span> <span class="s2">&quot;svm&quot;</span><span class="p">,</span> <span class="s2">&quot;ridge&quot;</span><span class="p">})],</span>
        <span class="s2">&quot;mida&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;boolean&quot;</span><span class="p">],</span>
        <span class="s2">&quot;search_strategy&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">StrOptions</span><span class="p">({</span><span class="s2">&quot;grid&quot;</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">})],</span>
        <span class="s2">&quot;cv&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;cv_object&quot;</span><span class="p">],</span>
        <span class="s2">&quot;scoring&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">StrOptions</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">get_scorer_names</span><span class="p">())),</span> <span class="nb">list</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="s2">&quot;num_solver_iterations&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Interval</span><span class="p">(</span><span class="n">Integral</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)],</span>
        <span class="s2">&quot;num_search_iterations&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Interval</span><span class="p">(</span><span class="n">Integral</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)],</span>
        <span class="s2">&quot;num_jobs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Integral</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="s2">&quot;random_state&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;random_state&quot;</span><span class="p">],</span>
        <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">prefer_skip_nested_validation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_trainer</span><span class="p">(</span>
    <span class="n">classifier</span><span class="o">=</span><span class="s2">&quot;logistic&quot;</span><span class="p">,</span>
    <span class="n">mida</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">search_strategy</span><span class="o">=</span><span class="s2">&quot;grid&quot;</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">num_solver_iterations</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">num_search_iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">num_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a trainer for a classification model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    classifier : str, default=&quot;logistic&quot;</span>
<span class="sd">        The classifier to use. Can be &quot;logistic&quot;, &quot;svm&quot;, or &quot;ridge&quot;.</span>

<span class="sd">    mida : bool, default=False</span>
<span class="sd">        Whether to use MIDA for site-dependency reduction.</span>

<span class="sd">    search_strategy : str, default=&quot;grid&quot;</span>
<span class="sd">        The search strategy for hyperparameter tuning. Can be &quot;grid&quot; or &quot;random&quot;.</span>

<span class="sd">    cv : int, cross-validation generator, or iterable, default=None</span>
<span class="sd">        The cross-validation splitting strategy. If None, the default 5-fold</span>
<span class="sd">        cross-validation is used.</span>

<span class="sd">    scoring : str, list of str, callable, or None, default=None</span>
<span class="sd">        A single string or a list of strings to use as the scoring metric(s).</span>
<span class="sd">        If None, the default scoring metric for the classifier is used.</span>

<span class="sd">    num_solver_iterations : int, default=100</span>
<span class="sd">        The number of iterations for the solver. This is used to set the</span>
<span class="sd">        max_iter parameter of the classifier.</span>

<span class="sd">    num_search_iterations : int, default=10</span>
<span class="sd">        The number of iterations for the random search. This is only used</span>
<span class="sd">        if search_strategy is &quot;random&quot;.</span>

<span class="sd">    num_jobs : int, default=None</span>
<span class="sd">        The number of jobs to run in parallel with joblib.Parallel. If None,</span>
<span class="sd">        the number of jobs is set to run on a single core.</span>

<span class="sd">    random_state : int, RandomState instance, or None, default=None</span>
<span class="sd">        The random seed for the random number generator. If None, the</span>
<span class="sd">        random state is not set.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    trainer : sklearn.model_selection.BaseSearchCV or MIDATrainer</span>
<span class="sd">        The model trainer object. This can be either a GridSearchCV,</span>
<span class="sd">        RandomizedSearchCV, or MIDATrainer object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;modeling.create_trainer&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating trainer with classifier: </span><span class="si">{</span><span class="n">classifier</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using MIDA: </span><span class="si">{</span><span class="n">mida</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search strategy: </span><span class="si">{</span><span class="n">search_strategy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scoring: </span><span class="si">{</span><span class="n">scoring</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of solver iterations: </span><span class="si">{</span><span class="n">num_solver_iterations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of search iterations: </span><span class="si">{</span><span class="n">num_search_iterations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of jobs: </span><span class="si">{</span><span class="n">num_jobs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random state: </span><span class="si">{</span><span class="n">random_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Generate classifier with its parameter grid</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">CLASSIFIER</span><span class="p">[</span><span class="n">classifier</span><span class="p">])</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="n">num_solver_iterations</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">param_grid</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">CLASSIFIER_GRID</span><span class="p">[</span><span class="n">classifier</span><span class="p">],</span> <span class="n">safe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Update with MIDA&#39;s parameters if we are using MIDA</span>
    <span class="k">if</span> <span class="n">mida</span><span class="p">:</span>
        <span class="n">param_grid</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">MIDA_GRID</span><span class="p">)</span>

    <span class="c1"># Construct trainer</span>
    <span class="n">trainer_args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;cv&quot;</span><span class="p">:</span> <span class="n">check_cv</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">classifier</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="s2">&quot;scoring&quot;</span><span class="p">:</span> <span class="n">scoring</span><span class="p">,</span>
        <span class="s2">&quot;refit&quot;</span><span class="p">:</span> <span class="n">scoring</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scoring</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">scoring</span><span class="p">,</span>
        <span class="s2">&quot;n_jobs&quot;</span><span class="p">:</span> <span class="n">num_jobs</span><span class="p">,</span>
        <span class="s2">&quot;error_score&quot;</span><span class="p">:</span> <span class="s2">&quot;raise&quot;</span><span class="p">,</span>
        <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="n">verbose</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished constructing trainer.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mida</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MIDATrainer</span><span class="p">(</span>
            <span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span>
            <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span>
            <span class="n">search_strategy</span><span class="o">=</span><span class="n">search_strategy</span><span class="p">,</span>
            <span class="n">num_iter</span><span class="o">=</span><span class="n">num_search_iterations</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
            <span class="o">**</span><span class="n">trainer_args</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">search_strategy</span> <span class="o">==</span> <span class="s2">&quot;grid&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="o">**</span><span class="n">trainer_args</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span>
        <span class="n">param_distributions</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span>
        <span class="n">n_iter</span><span class="o">=</span><span class="n">num_search_iterations</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
        <span class="o">**</span><span class="n">trainer_args</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="evaluation">
<h3>Evaluation<a class="headerlink" href="#evaluation" title="Link to this heading">#</a></h3>
<p>Contains a function to <strong>aggregate the top-1 cross-validation scores</strong> for each defined model, selecting the best-performing configuration per model based on a specified evaluation metric.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils._param_validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_params</span><span class="p">,</span> <span class="n">StrOptions</span>

<span class="c1"># Mapping for model and score display names</span>
<span class="n">MODEL</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;baseline&quot;</span><span class="p">,</span> <span class="s2">&quot;site_only&quot;</span><span class="p">,</span> <span class="s2">&quot;all_phenotypes&quot;</span><span class="p">]</span>
<span class="n">MODEL</span> <span class="o">=</span> <span class="p">{</span><span class="n">model</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">MODEL</span><span class="p">}</span>

<span class="n">SCORE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;f1&quot;</span><span class="p">]</span>
<span class="n">SCORE</span> <span class="o">=</span> <span class="p">{</span><span class="n">score</span><span class="p">:</span> <span class="n">score</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">SCORE</span><span class="p">}</span>
<span class="n">SCORE</span><span class="p">[</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;AUROC&quot;</span>
<span class="n">SCORE</span><span class="p">[</span><span class="s2">&quot;matthews_corrcoef&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MCC&quot;</span>


<span class="nd">@validate_params</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;cv_results&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="s2">&quot;sort_by&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">StrOptions</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">SCORE</span><span class="p">))]},</span>
    <span class="n">prefer_skip_nested_validation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compile_results</span><span class="p">(</span><span class="n">cv_results</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compile and summarize cross-validation results into a formatted DataFrame.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cv_results : dict of str -&gt; pd.DataFrame or dict of str -&gt; dict of str -&gt; list</span>
<span class="sd">        Dictionary mapping model names to cross-validation results.</span>
<span class="sd">        Each entry should either be a DataFrame or a dictionary of dictionary of list.</span>
<span class="sd">    sort_by : str</span>
<span class="sd">        Metric to use for selecting the best-performing model variant.</span>
<span class="sd">        Available ones include: &quot;accuracy&quot;, &quot;precision&quot;, &quot;recall&quot;, &quot;f1&quot;, &quot;roc_auc&quot;,</span>
<span class="sd">        and &quot;matthews_corrcoef&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    compiled_results : pd.DataFrame</span>
<span class="sd">        Summary table with models as rows and formatted score strings (mean ± std) as columns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">compiled_results</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">cv_results</span><span class="p">:</span>
        <span class="c1"># Ensure results are in DataFrame format</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">model</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">cv_results</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">model</span><span class="p">])</span>

        <span class="c1"># Extract all available test scores</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">score</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;rank_test_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">cv_results</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">if</span> <span class="s2">&quot;rank_test&quot;</span> <span class="ow">in</span> <span class="n">score</span>
        <span class="p">]</span>

        <span class="c1"># Select the best row (lowest rank) based on the given metric</span>
        <span class="n">cv_result</span> <span class="o">=</span> <span class="n">cv_results</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rank_test_</span><span class="si">{</span><span class="n">sort_by</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">compiled_results</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MODEL</span><span class="p">[</span><span class="n">model</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">:</span>
            <span class="n">mean_score</span> <span class="o">=</span> <span class="n">cv_result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;mean_test_</span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">std_score</span> <span class="o">=</span> <span class="n">cv_result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;std_test_</span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">compiled_results</span><span class="p">[</span><span class="n">SCORE</span><span class="p">[</span><span class="n">score</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mean_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">std_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Convert to DataFrame and index by model name</span>
    <span class="n">compiled_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">compiled_results</span><span class="p">)</span>
    <span class="n">compiled_results</span> <span class="o">=</span> <span class="n">compiled_results</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Model&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">compiled_results</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="visualization">
<h3>Visualization<a class="headerlink" href="#visualization" title="Link to this heading">#</a></h3>
<p>Provides utility functions to:</p>
<ul class="simple">
<li><p>Generate <strong>pairwise ROI labels</strong>,</p></li>
<li><p>Extract the <strong>top-p most important weights</strong> and convert them into a <strong>symmetric matrix</strong>,</p></li>
<li><p>Wrap the process of <strong>plotting connectomes</strong> for visual interpretation of model-derived feature importances.</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.cm</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_cmap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nilearn.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_connectome</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils._param_validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">Interval</span><span class="p">,</span> <span class="n">validate_params</span><span class="p">,</span> <span class="n">Real</span>


<span class="nd">@validate_params</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;rois&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;array-like&quot;</span><span class="p">],</span> <span class="s2">&quot;sep&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">]},</span> <span class="n">prefer_skip_nested_validation</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_pairwise_rois</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;---&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate all unique ROI pair labels (upper triangle only).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rois : array-like of str or int</span>
<span class="sd">        List of region-of-interest (ROI) names.</span>
<span class="sd">    sep : str, optional</span>
<span class="sd">        Separator string used to join ROI pairs, by default &#39;---&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pairs : np.ndarray</span>
<span class="sd">        Array of ROI pair strings in the format &quot;ROI1 --- ROI2&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">sep</span><span class="si">}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>


<span class="nd">@validate_params</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;array-like&quot;</span><span class="p">],</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;array-like&quot;</span><span class="p">],</span>
        <span class="s2">&quot;coords&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;array-like&quot;</span><span class="p">],</span>
        <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Interval</span><span class="p">(</span><span class="n">Real</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s2">&quot;neither&quot;</span><span class="p">)],</span>
        <span class="s2">&quot;sep&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">prefer_skip_nested_validation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_top_symmetric_weight</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;---&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a symmetric weight matrix for top-p ROI pairs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights : array-like</span>
<span class="sd">        1D array of weights corresponding to pairwise ROI combinations.</span>
<span class="sd">    labels : array-like of str or int</span>
<span class="sd">        List of all ROI names or indices in the original data.</span>
<span class="sd">    coords : array-like</span>
<span class="sd">        Coordinates of each ROI, shape (n_rois, 3).</span>
<span class="sd">    p : float, optional</span>
<span class="sd">        Proportion of top weights to retain (default is 0.001).</span>
<span class="sd">    sep : str, optional</span>
<span class="sd">        Separator used in ROI pair labels, by default &#39;---&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sym_weights : array-like</span>
<span class="sd">        Symmetric matrix of selected top weights (n_top_rois, n_top_rois).</span>
<span class="sd">    top_roi_labels : array-like</span>
<span class="sd">        Labels of ROIs included in the top-p weight pairs.</span>
<span class="sd">    top_roi_coords : array-like</span>
<span class="sd">        Coordinates corresponding to `top_roi_labels`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">get_pairwise_rois</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="p">))</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">rank</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

    <span class="n">pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">roi</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
    <span class="n">unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>

    <span class="n">label_to_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">)}</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_to_index</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">]</span>

    <span class="n">top_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">top_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords</span><span class="p">)[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">mappings</span> <span class="o">=</span> <span class="p">{</span><span class="n">roi</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_labels</span><span class="p">)}</span>

    <span class="n">sym_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">roi1</span><span class="p">,</span> <span class="n">roi2</span><span class="p">),</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">mappings</span><span class="p">[</span><span class="n">roi1</span><span class="p">],</span> <span class="n">mappings</span><span class="p">[</span><span class="n">roi2</span><span class="p">]</span>
        <span class="n">sym_weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="n">sym_weights</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>

    <span class="k">return</span> <span class="n">sym_weights</span><span class="p">,</span> <span class="n">top_labels</span><span class="p">,</span> <span class="n">top_coords</span>


<span class="nd">@validate_params</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;array-like&quot;</span><span class="p">],</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;array-like&quot;</span><span class="p">],</span>
        <span class="s2">&quot;coords&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;array-like&quot;</span><span class="p">],</span>
        <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Interval</span><span class="p">(</span><span class="n">Real</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s2">&quot;neither&quot;</span><span class="p">)],</span>
        <span class="s2">&quot;cmap&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="s2">&quot;marker_size&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Real</span><span class="p">],</span>
        <span class="s2">&quot;legend_params&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">prefer_skip_nested_validation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">visualize_connectome</span><span class="p">(</span>
    <span class="n">weights</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;tab20&quot;</span><span class="p">,</span> <span class="n">marker_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">legend_params</span><span class="o">=</span><span class="p">{}</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize the top-p weighted ROI connections as a symmetric connectome plot.</span>

<span class="sd">    This function selects the top proportion `p` of the largest (by absolute value)</span>
<span class="sd">    weights between region pairs, constructs a symmetric connectivity matrix,</span>
<span class="sd">    and plots the corresponding connectome using `nilearn.plotting.plot_connectome`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights : array-like of shape (n_edges,)</span>
<span class="sd">        Weights assigned to each unique pair of ROIs, typically from a model or analysis.</span>
<span class="sd">        These are expected to align with the order of ROI pairs generated from `labels`.</span>

<span class="sd">    labels : array-like of shape (n_rois,)</span>
<span class="sd">        List of ROI (region of interest) names corresponding to the original brain atlas.</span>

<span class="sd">    coords : array-like of shape (n_rois, 3)</span>
<span class="sd">        3D coordinates for each ROI, used to place nodes in the plot.</span>

<span class="sd">    p : float, optional</span>
<span class="sd">        Proportion of the top-weighted connections (by absolute value) to include.</span>
<span class="sd">        Must be in the open interval (0, 1). Default is 0.001 (0.1%).</span>

<span class="sd">    cmap : str, optional</span>
<span class="sd">        Matplotlib colormap name used to assign colors to ROI nodes. Default is &#39;tab20&#39;.</span>

<span class="sd">    marker_size : float, optional</span>
<span class="sd">        Size of ROI node markers in the connectome plot. Default is 100.</span>

<span class="sd">    legend_params : dict, optional</span>
<span class="sd">        Additional keyword arguments to pass to the plot&#39;s legend (e.g., location, fontsize).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    proj : nilearn.plotting.displays._projectors.ConnectivityProjection</span>
<span class="sd">        A `nilearn` projection object with the plotted connectome. This object supports</span>
<span class="sd">        further customization (e.g., adding markers, saving the figure).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - This function assumes the weights are symmetric or that symmetry should be imposed.</span>
<span class="sd">    - Useful for visualizing model interpretability or structural/functional connectivity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">marker_colors</span> <span class="o">=</span> <span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)))</span>
    <span class="n">sym_weights</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">coords</span> <span class="o">=</span> <span class="n">get_top_symmetric_weight</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">plot_connectome</span><span class="p">(</span><span class="n">sym_weights</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)):</span>
        <span class="n">proj</span><span class="o">.</span><span class="n">add_markers</span><span class="p">(</span>
            <span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
            <span class="n">marker_color</span><span class="o">=</span><span class="n">marker_colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">marker_size</span><span class="o">=</span><span class="n">marker_size</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="n">proj</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">proj</span><span class="o">.</span><span class="n">axes</span><span class="p">))]</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">**</span><span class="n">legend_params</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">proj</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="pipeline">
<h1>Pipeline<a class="headerlink" href="#pipeline" title="Link to this heading">#</a></h1>
<section id="resting-state-fmri-preprocessing">
<h2>Resting-state fMRI Preprocessing<a class="headerlink" href="#resting-state-fmri-preprocessing" title="Link to this heading">#</a></h2>
<p>Typically, raw fMRI scans require extensive preprocessing before they can be used in a machine learning pipeline. However, the <strong>ABIDE</strong> dataset provides several preprocessed derivatives, which can be downloaded directly from the <a class="reference external" href="https://preprocessed-connectomes-project.org/abide/">Preprocessed Connectomes Project (PCP)</a>, eliminating the need for manual preprocessing.</p>
<p>In this tutorial, we focus on the following preprocessing options:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">atlas</span></code>: The <strong>brain atlas</strong> used to <strong>extract ROI time series</strong>. Available options include: <code class="docutils literal notranslate"><span class="pre">&quot;aal&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;cc200&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;cc400&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;dosenbach160&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;ez&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;ho&quot;</span></code>, and <code class="docutils literal notranslate"><span class="pre">&quot;tt&quot;</span></code>. Default: <code class="docutils literal notranslate"><span class="pre">&quot;aal&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bp</span></code>: Whether to apply <strong>band-pass filter</strong> to the time series between [0.01, 0.1] Hz. Default: <code class="docutils literal notranslate"><span class="pre">False</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gsr</span></code>: Whether to apply <strong>global signal regression</strong> to remove shared global noise from the signals. Default: <code class="docutils literal notranslate"><span class="pre">False</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">qc</span></code>: Whether to include <strong>only scans that passed all quality checks</strong> provided by the dataset curators. Default: <code class="docutils literal notranslate"><span class="pre">True</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">nilearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">fetch_abide_pcp</span>

<span class="c1"># Define preprocessing options</span>
<span class="n">atlas</span> <span class="o">=</span> <span class="s2">&quot;aal&quot;</span>  <span class="c1"># Brain atlas used to extract ROI time series (e.g., AAL atlas)</span>
<span class="n">bp</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Apply band-pass filtering (0.01–0.1 Hz) to remove low- and high-frequency noise</span>
<span class="n">gsr</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Do not apply global signal regression (GSR)</span>
<span class="n">qc</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Include all subjects regardless of quality control status</span>

<span class="c1"># Fetch the preprocessed ABIDE dataset using the specified preprocessing options</span>
<span class="c1"># This returns a dictionary containing region-wise time series and associated metadata</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">fetch_abide_pcp</span><span class="p">(</span>
    <span class="n">derivatives</span><span class="o">=</span><span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;rois_</span><span class="si">{</span><span class="n">atlas</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">],</span>  <span class="c1"># Select the atlas-specific ROI time series (e.g., &#39;rois_aal&#39;)</span>
    <span class="n">band_pass_filtering</span><span class="o">=</span><span class="n">bp</span><span class="p">,</span>  <span class="c1"># Whether to apply band-pass filtering</span>
    <span class="n">global_signal_regression</span><span class="o">=</span><span class="n">gsr</span><span class="p">,</span>  <span class="c1"># Whether to apply global signal regression</span>
    <span class="n">quality_checked</span><span class="o">=</span><span class="n">qc</span><span class="p">,</span>  <span class="c1"># Whether to include only subjects that passed QC</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[get_dataset_dir] Dataset found in /home/zarizky/nilearn_data/ABIDE_pcp
</pre></div>
</div>
</div>
</div>
</section>
<section id="phenotype-preprocessing">
<h2>Phenotype Preprocessing<a class="headerlink" href="#phenotype-preprocessing" title="Link to this heading">#</a></h2>
<p>The phenotypic information in the dataset contains several missing values. We impute and encode it to make it suitable for modeling.</p>
<p><strong>Categorical Variables</strong></p>
<p>The following categorical phenotypes are used and will be <strong>one-hot encoded</strong>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SITE_ID</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SEX</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HANDEDNESS_CATEGORY</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EYE_STATUS_AT_SCAN</span></code></p></li>
</ul>
<p><strong>Continuous Variables</strong></p>
<p>The following continuous phenotypes will optionally be <strong>standardized</strong>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">AGE_AT_SCAN</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FIQ</span></code></p></li>
</ul>
<p>Possible options to <code class="docutils literal notranslate"><span class="pre">standardize</span></code> the continuous phenotypes includes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;all&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">True</span></code>: Standardize across all subjects</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;site&quot;</span></code>: Standardize within each site</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code>: No standardization</p></li>
</ul>
<p><strong>Handling Missing Values</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">HANDEDNESS_CATEGORY</span></code>: Missing values are assumed to correspond to <code class="docutils literal notranslate"><span class="pre">right-handed</span></code> subjects.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FIQ</span></code>: Missing values are imputed with a default score of <code class="docutils literal notranslate"><span class="pre">100</span></code>.</p></li>
</ul>
<p><strong>Label Encoding</strong></p>
<p>The diagnostic label <code class="docutils literal notranslate"><span class="pre">DX_GROUP</span></code> is used to assign the target class:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CONTROL</span></code> → <code class="docutils literal notranslate"><span class="pre">0</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ASD</span></code> → <code class="docutils literal notranslate"><span class="pre">1</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">standardize</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;site&quot;</span>  <span class="c1"># Standardize continuous phenotypes (e.g., age, FIQ) within each site</span>
<span class="p">)</span>

<span class="c1"># Process the phenotypic metadata from the ABIDE dataset</span>
<span class="c1"># This function handles:</span>
<span class="c1"># - Imputation of missing values (e.g., assuming right-handed for missing handedness)</span>
<span class="c1"># - One-hot encoding of categorical variables (e.g., sex, site, eye status)</span>
<span class="c1"># - Standardization of continuous variables based on the chosen strategy (&#39;site&#39; or &#39;all&#39;)</span>

<span class="c1"># Returns:</span>
<span class="c1"># - `labels`: Binary class labels (0 = control, 1 = ASD)</span>
<span class="c1"># - `sites`: Site identifiers for domain adaptation</span>
<span class="c1"># - `phenotypes`: Feature matrix containing encoded and standardized phenotypic variables</span>
<span class="n">labels</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">phenotypes</span> <span class="o">=</span> <span class="n">process_phenotypic_data</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;phenotypic&quot;</span><span class="p">],</span> <span class="n">standardize</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h2>Feature Extraction<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<p>Functional MRI (fMRI) time series data often vary in temporal length. However, many machine learning models, including those used in this study require fixed-size input. To address this, a common approach in fMRI analysis is to compute the functional connectivity (e.g., correlation) between regions of interest (ROIs), resulting in a fixed-size feature representation.</p>
<p>Specifically, we compute a connectivity matrix for each subject, and extract the upper or lower triangular part (excluding the diagonal) to obtain a feature vector suitable for model training.</p>
<p>The available arguments for feature extraction are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">measures</span></code>: A sequence of connectivity transformations applied to the ROI time series. Supported options include: <code class="docutils literal notranslate"><span class="pre">&quot;pearson&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;partial&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;tangent&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;covariance&quot;</span></code>, and <code class="docutils literal notranslate"><span class="pre">&quot;precision&quot;</span></code>. Default: <code class="docutils literal notranslate"><span class="pre">[&quot;pearson&quot;]</span></code>.</p></li>
</ul>
<p>Multiple transformations can be chained to compute composite connectivity representations. For example, the <strong>Tangent-Pearson</strong> method proposed by <em>Kunda et al.</em> can be specified via <code class="docutils literal notranslate"><span class="pre">measures</span> <span class="pre">=</span> <span class="pre">[&quot;tangent&quot;,</span> <span class="pre">&quot;pearson&quot;]</span></code>. This design also allows for future extensions to support higher-order connectivity features.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Given the long runtime needed for Tangent-Pearson, we opt to use <code class="docutils literal notranslate"><span class="pre">&quot;pearson&quot;</span></code> by default.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">measures</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pearson&quot;</span><span class="p">]</span>  <span class="c1"># Use Pearson correlation to compute functional connectivity</span>

<span class="c1"># Extract functional connectivity features from ROI time series using the specified measure</span>
<span class="c1"># - `dataset[f&quot;rois_{atlas}&quot;]`: Time series data extracted from the selected brain atlas (e.g., AAL)</span>
<span class="c1"># - `measures`: List of connectivity measures to apply; in this case, only Pearson correlation is used</span>
<span class="c1">#   to compute pairwise correlations between ROI time series, resulting in a symmetric connectivity matrix</span>

<span class="n">features</span> <span class="o">=</span> <span class="n">extract_functional_connectivity</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;rois_</span><span class="si">{</span><span class="n">atlas</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">measures</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="modeling">
<h2>Modeling<a class="headerlink" href="#modeling" title="Link to this heading">#</a></h2>
<p>We define and train machine learning models for classifying autism spectrum disorder (ASD) using functional connectivity features.</p>
<p>We explore different configurations including a baseline model, domain adaptation using site information, and an extended approach that incorporates additional phenotypic variables.</p>
<p>Each model is evaluated using cross-validation, and we analyze the impact of domain adaptation on classification performance.</p>
<section id="random-seed">
<h3>Random Seed<a class="headerlink" href="#random-seed" title="Link to this heading">#</a></h3>
<p>To ensure reproducibility across runs, we define a fixed random seed. This guarantees that all operations involving randomness, such as cross-validation splits, model initialization, and hyperparameter search to produce consistent results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils.validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_random_state</span>

<span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Set a fixed seed for reproducibility</span>

<span class="c1"># Convert the seed into a numpy-compatible RandomState instance</span>
<span class="c1"># This ensures consistent behavior across scikit-learn functions that rely on randomness</span>
<span class="n">random_state</span> <span class="o">=</span> <span class="n">check_random_state</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="cross-validation-split">
<h3>Cross-Validation Split<a class="headerlink" href="#cross-validation-split" title="Link to this heading">#</a></h3>
<p>To evaluate model performance reliably, we define a cross-validation (CV) strategy. By default, we use <strong>Repeated Stratified K-Fold</strong>, which preserves class distribution across folds and supports repeated trials for more stable estimates.</p>
<p>Alternatively, we can also use <strong>Leave-P-Groups-Out (LPGO)</strong> cross-validation. This strategy is particularly useful in multi-site studies, as it ensures that data from the same group (e.g., imaging site) are not shared between training and test sets, enabling more realistic generalization assessment under domain shift.</p>
<p>For this tutorial we will specify several arguments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">split</span></code>: Defines the cross-validation strategy. <code class="docutils literal notranslate"><span class="pre">&quot;skf&quot;</span></code> for stratified k-fold to maintain label balance in each fold or use <code class="docutils literal notranslate"><span class="pre">&quot;lpgo&quot;</span></code> to evaluate generalization across sites by holding out entire groups (e.g., imaging sites). Default: <code class="docutils literal notranslate"><span class="pre">&quot;lpgo&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_folds</span></code>: Sets how many folds to use for stratified k-fold or how many groups to leave out in LPGO. Default: <code class="docutils literal notranslate"><span class="pre">1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_cv_repeats</span></code>: Determines how many times the k-fold procedure is repeated to obtain more stable estimates (ignored when using LPGO). Default: <code class="docutils literal notranslate"><span class="pre">1</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">LeavePGroupsOut</span><span class="p">,</span> <span class="n">RepeatedStratifiedKFold</span>

<span class="n">split</span> <span class="o">=</span> <span class="s2">&quot;lpgo&quot;</span>  <span class="c1"># Cross-validation split strategy</span>
<span class="n">num_folds</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Number of folds (or groups to leave out)</span>
<span class="n">num_cv_repeats</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Number of repetitions (used only for skf)</span>

<span class="c1"># Define the default cross-validation strategy:</span>
<span class="c1"># Repeated stratified k-fold maintains class distribution across folds and supports multiple repetitions</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">RepeatedStratifiedKFold</span><span class="p">(</span>
    <span class="n">n_splits</span><span class="o">=</span><span class="n">num_folds</span><span class="p">,</span>  <span class="c1"># Number of stratified folds</span>
    <span class="n">n_repeats</span><span class="o">=</span><span class="n">num_cv_repeats</span><span class="p">,</span>  <span class="c1"># Number of repeat rounds</span>
    <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>  <span class="c1"># Ensures reproducibility</span>
<span class="p">)</span>

<span class="c1"># Override with leave-p-proups-out if specified</span>
<span class="c1"># This strategy holds out `p` unique groups (e.g., sites) per fold, enabling group-level generalization</span>
<span class="k">if</span> <span class="n">split</span> <span class="o">==</span> <span class="s2">&quot;lpgo&quot;</span><span class="p">:</span>
    <span class="n">cv</span> <span class="o">=</span> <span class="n">LeavePGroupsOut</span><span class="p">(</span>
        <span class="n">num_folds</span>
    <span class="p">)</span>  <span class="c1"># Use group-based CV for domain adaptation or site bias evaluation</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-definition">
<h3>Model Definition<a class="headerlink" href="#model-definition" title="Link to this heading">#</a></h3>
<p>We define different model configurations used for classification. Each model shares the same base classifier (e.g., logistic regression), but differs in how domain adaptation is applied:</p>
<ul class="simple">
<li><p><strong>Baseline</strong>: A standard model trained directly on functional connectivity features without domain adaptation.</p></li>
<li><p><strong>Site Only</strong>: A domain-adapted model that uses site labels as the adaptation factor, reducing site-specific bias.</p></li>
<li><p><strong>All Phenotypes</strong>: An extended domain-adapted model that incorporates multiple phenotypic variables (e.g., age, sex, handedness) to further reduce inter-site variability.</p></li>
</ul>
<p>We also specify the hyperparameter search strategy and other training parameters for each configuration, including:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">classifier</span></code>: The base model to use for classification. Available options include <code class="docutils literal notranslate"><span class="pre">&quot;logistic&quot;</span></code> for logistic regression, <code class="docutils literal notranslate"><span class="pre">&quot;ridge&quot;</span></code> for ridge classifier, and <code class="docutils literal notranslate"><span class="pre">&quot;svm&quot;</span></code> for support vector machines. Default: <code class="docutils literal notranslate"><span class="pre">&quot;logistic&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scoring</span></code>: A list of performance metrics (e.g., accuracy, F1, AUROC) used during cross-validation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_solver_iterations</span></code>: Maximum number of iterations allowed for the solver to converge during model fitting.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_search_iterations</span></code>: Number of hyperparameter combinations to evaluate in a randomized search.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_jobs</span></code>: Number of CPU cores used in parallel for hyperparameter tuning and model training. Set to <code class="docutils literal notranslate"><span class="pre">-1</span></code> to use all of the available CPU cores or <code class="docutils literal notranslate"><span class="pre">-k</span></code> to use all but <code class="docutils literal notranslate"><span class="pre">k</span></code> CPU cores.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">verbose</span></code>: Controls the verbosity of the training output. Higher values provide more detailed logs.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">clone</span>

<span class="c1"># Define core training configuration</span>
<span class="n">classifier</span> <span class="o">=</span> <span class="s2">&quot;logistic&quot;</span>  <span class="c1"># Classifier type (e.g., &#39;logistic&#39;, &#39;svm&#39;, etc.)</span>
<span class="n">scoring</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">SCORE</span><span class="p">)</span>  <span class="c1"># List of scoring metrics to evaluate during CV</span>
<span class="n">num_solver_iterations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>  <span class="c1"># Max iterations for the solver to converge</span>
<span class="n">num_search_iterations</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Number of parameter settings sampled in randomized search</span>
<span class="n">num_jobs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span>  <span class="c1"># Number of parallel jobs for training and CV</span>
<span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Verbosity level for output</span>

<span class="c1"># Initialize dictionary to store trainer instances for each model configuration</span>
<span class="n">trainers</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Create a baseline trainer without domain adaptation (MIDA disabled)</span>
<span class="n">trainers</span><span class="p">[</span><span class="s2">&quot;baseline&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_trainer</span><span class="p">(</span>
    <span class="n">classifier</span><span class="p">,</span>  <span class="c1"># Classifier to use</span>
    <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Do not apply MIDA (no domain adaptation)</span>
    <span class="s2">&quot;grid&quot;</span><span class="p">,</span>  <span class="c1"># Use grid search for hyperparameter tuning</span>
    <span class="n">cv</span><span class="p">,</span>  <span class="c1"># Cross-validation strategy</span>
    <span class="n">scoring</span><span class="p">,</span>  <span class="c1"># Evaluation metrics</span>
    <span class="n">num_solver_iterations</span><span class="p">,</span>  <span class="c1"># Max solver iterations</span>
    <span class="n">num_search_iterations</span><span class="p">,</span>  <span class="c1"># Max hyperparameter trials (ignored for grid search)</span>
    <span class="n">num_jobs</span><span class="p">,</span>  <span class="c1"># Number of parallel jobs</span>
    <span class="n">random_state</span><span class="p">,</span>  <span class="c1"># Random seed for reproducibility</span>
    <span class="n">verbose</span><span class="p">,</span>  <span class="c1"># Verbosity level</span>
<span class="p">)</span>

<span class="c1"># Create a trainer with MIDA enabled, using site labels as domain adaptation factors</span>
<span class="n">trainers</span><span class="p">[</span><span class="s2">&quot;site_only&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_trainer</span><span class="p">(</span>
    <span class="n">classifier</span><span class="p">,</span>
    <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Apply MIDA for domain adaptation</span>
    <span class="s2">&quot;random&quot;</span><span class="p">,</span>  <span class="c1"># Use randomized search for hyperparameter tuning</span>
    <span class="n">cv</span><span class="p">,</span>
    <span class="n">scoring</span><span class="p">,</span>
    <span class="n">num_solver_iterations</span><span class="p">,</span>
    <span class="n">num_search_iterations</span><span class="p">,</span>
    <span class="n">num_jobs</span><span class="p">,</span>
    <span class="n">random_state</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Clone the &#39;site_only&#39; trainer to create &#39;all_phenotypes&#39; trainer</span>
<span class="c1"># This enables reusing the same training configuration, while modifying only the input domain factors</span>
<span class="n">trainers</span><span class="p">[</span><span class="s2">&quot;all_phenotypes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">trainers</span><span class="p">[</span><span class="s2">&quot;site_only&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="training-and-cross-validation">
<h2>Training and Cross-Validation<a class="headerlink" href="#training-and-cross-validation" title="Link to this heading">#</a></h2>
<p>We train each model configuration using the previously defined cross-validation strategy. The training process involves fitting the model on functional connectivity features and evaluating its performance using multiple scoring metrics (e.g., accuracy, F1-score, AUROC).</p>
<p>For models with domain adaptation, we pass additional domain factors (such as site or phenotypic variables) to guide the alignment of feature representations. Cross-validation is performed to ensure robust performance estimates and to select the best hyperparameter configuration for each model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define common training arguments for all models: features (X), labels (y), and group info (sites)</span>
<span class="n">fit_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">features</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="n">sites</span><span class="p">}</span>

<span class="c1"># Fit the baseline model using raw features (no domain adaptation)</span>
<span class="n">trainers</span><span class="p">[</span><span class="s2">&quot;baseline&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">**</span><span class="n">fit_args</span><span class="p">)</span>

<span class="c1"># Prepare arguments for MIDA-based models by renaming X -&gt; x (MIDA uses &#39;x&#39;)</span>
<span class="n">fit_args_mida</span> <span class="o">=</span> <span class="n">fit_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">fit_args_mida</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_args_mida</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>

<span class="c1"># Add one-hot encoded site information as domain factors for MIDA</span>
<span class="n">fit_args_mida</span><span class="p">[</span><span class="s2">&quot;factors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span>

<span class="c1"># Fit the &#39;site_only&#39; model using domain adaptation with site labels only</span>
<span class="n">trainers</span><span class="p">[</span><span class="s2">&quot;site_only&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">**</span><span class="n">fit_args_mida</span><span class="p">)</span>

<span class="c1"># Update the MIDA input to include full phenotype metadata (e.g., age, gender, site)</span>
<span class="n">fit_args_mida</span><span class="p">[</span><span class="s2">&quot;factors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phenotypes</span>

<span class="c1"># Fit the &#39;all_phenotypes&#39; model using full metadata as domain-relevant factors</span>
<span class="n">trainers</span><span class="p">[</span><span class="s2">&quot;all_phenotypes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">**</span><span class="n">fit_args_mida</span><span class="p">)</span>

<span class="c1"># Collect cross-validation results from each trained model for later comparison</span>
<span class="n">cv_results</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">trainers</span><span class="p">:</span>
    <span class="c1"># Store each model&#39;s cv_results_ (e.g., scores, ranks) in a DataFrame</span>
    <span class="n">cv_results</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">trainers</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fitting 20 folds for each of 31 candidates, totalling 620 fits
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h2>Evaluation<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>We evaluate and compare the performance of different model configurations using cross-validation results. We aggregate the top-performing scores for each model based on a specified evaluation metric (e.g., accuracy), allowing us to assess the effectiveness of domain adaptation strategies.</p>
<p>By comparing models with and without domain adaptation, we can determine the impact of incorporating site and phenotypic information on multi-site autism classification performance. This analysis helps identify which configurations generalize best across heterogeneous imaging sites.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compile the cross-validation results into a summary table,</span>
<span class="c1"># sorting by the model with the highest test accuracy across CV folds</span>
<span class="n">compiled_results</span> <span class="o">=</span> <span class="n">compile_results</span><span class="p">(</span><span class="n">cv_results</span><span class="p">,</span> <span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>

<span class="c1"># Display the compiled results DataFrame (models as rows, metrics as formatted strings)</span>
<span class="n">display</span><span class="p">(</span><span class="n">compiled_results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Accuracy</th>
      <th>Precision</th>
      <th>Recall</th>
      <th>F1</th>
      <th>AUROC</th>
      <th>MCC</th>
    </tr>
    <tr>
      <th>Model</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Baseline</th>
      <td>0.6446 ± 0.0963</td>
      <td>0.6352 ± 0.1622</td>
      <td>0.5771 ± 0.1745</td>
      <td>0.5851 ± 0.1298</td>
      <td>0.6921 ± 0.1016</td>
      <td>0.2889 ± 0.1881</td>
    </tr>
    <tr>
      <th>Site Only</th>
      <td>0.6566 ± 0.0748</td>
      <td>0.6355 ± 0.1207</td>
      <td>0.5999 ± 0.0996</td>
      <td>0.6112 ± 0.0920</td>
      <td>0.6893 ± 0.1115</td>
      <td>0.3090 ± 0.1516</td>
    </tr>
    <tr>
      <th>All Phenotypes</th>
      <td>0.6567 ± 0.0927</td>
      <td>0.6216 ± 0.1328</td>
      <td>0.5834 ± 0.1743</td>
      <td>0.5909 ± 0.1595</td>
      <td>0.6898 ± 0.0978</td>
      <td>0.2909 ± 0.1869</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="interpretation">
<h2>Interpretation<a class="headerlink" href="#interpretation" title="Link to this heading">#</a></h2>
<p>We interpret the trained models by analyzing the learned weights associated with functional connectivity features. Specifically, we extract the top-weighted ROI pairs that contributed most to the classification decision.</p>
<p>These weights are visualized as a <strong>connectome plot</strong>, allowing us to examine which brain region interactions are most informative for distinguishing individuals with autism from controls. This not only enhances the interpretability of the model but also provides potential insights into neurobiological patterns relevant to autism.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">nilearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">fetch_atlas_aal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nilearn.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_parcellation_cut_coords</span>

<span class="c1"># Retrieve the trained model configured with all phenotypic metadata</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">trainers</span><span class="p">[</span><span class="s2">&quot;all_phenotypes&quot;</span><span class="p">]</span>

<span class="c1"># Fetch the AAL (Automated Anatomical Labeling) atlas</span>
<span class="c1"># Provides ROI labels and brain region maps</span>
<span class="n">atlas</span> <span class="o">=</span> <span class="n">fetch_atlas_aal</span><span class="p">()</span>

<span class="c1"># Extract 3D MNI coordinates for each ROI in the AAL atlas</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">find_parcellation_cut_coords</span><span class="p">(</span><span class="n">atlas</span><span class="o">.</span><span class="n">maps</span><span class="p">)</span>

<span class="c1"># Extract weights from the MIDA-transformed feature space (domain-adapted representation)</span>
<span class="n">mida_weights</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">best_mida_</span><span class="o">.</span><span class="n">orig_coef_</span>

<span class="c1"># Extract weights from the final classifier (e.g., logistic regression coefficients)</span>
<span class="n">classifier_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">best_estimator_</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Compute final feature-level weights by linearly combining MIDA and classifier weights</span>
<span class="c1"># Resulting in one scalar per connectivity feature</span>
<span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">mida_weights</span> <span class="o">@</span> <span class="n">classifier_weights</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># Visualize the top 0.2% strongest ROI-to-ROI connections using a connectome plot</span>
<span class="n">proj</span> <span class="o">=</span> <span class="n">visualize_connectome</span><span class="p">(</span>
    <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="n">atlas</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>  <span class="c1"># ROI names from the AAL atlas</span>
    <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  <span class="c1"># ROI spatial coordinates (MNI space)</span>
    <span class="n">p</span><span class="o">=</span><span class="mf">0.002</span><span class="p">,</span>  <span class="c1"># Visualize top 0.2% of weights by magnitude</span>
    <span class="n">legend_params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Region of Interest&quot;</span><span class="p">,</span>  <span class="c1"># Title shown above the legend</span>
        <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># Organize legend entries into 3 columns</span>
        <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower center&quot;</span><span class="p">,</span>  <span class="c1"># Legend anchor point</span>
        <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">),</span>  <span class="c1"># Adjust legend position</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Display the resulting connectome plot</span>
<span class="n">display</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[get_dataset_dir] Dataset found in /home/zarizky/nilearn_data/aal_SPM12
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;nilearn.plotting.displays._projectors.OrthoProjector at 0x7f03fca42d10&gt;
</pre></div>
</div>
<img alt="../_images/8ddd7c99661dff61ed85d3f2d06ec08abf12c8d702d83df52ceab6c5c990bfbf.png" src="../_images/8ddd7c99661dff61ed85d3f2d06ec08abf12c8d702d83df52ceab6c5c990bfbf.png" />
</div>
</div>
<p>This plot shows the <strong>most discriminative ROI connections</strong> for classifying ASD vs Control subjects.</p>
<ul class="simple">
<li><p><strong>Red edges</strong> indicate connections <strong>stronger in ASD</strong>.</p></li>
<li><p><strong>Blue edges</strong> indicate connections <strong>stronger in Control</strong>.</p></li>
<li><p>Color intensity reflects the <strong>magnitude of contribution</strong> to the model’s decision.</p></li>
</ul>
<hr class="docutils" />
<p><strong>Key Patterns</strong>:</p>
<ul class="simple">
<li><p><strong>Increased connectivity in ASD (Red</strong>):</p>
<ul>
<li><p>Between <strong>frontal regions</strong> (<em>Frontal_Inf_Tri_L</em>, <em>Frontal_Sup_R</em>) and <strong>limbic structures</strong> (<em>Hippocampus_R</em>, <em>Amygdala_L</em>), suggesting atypical emotional or executive function coupling.</p></li>
<li><p><strong>Temporal and subcortical regions</strong> (<em>Temporal_Pole_Mid_R</em>, <em>Putamen_R</em>) are also prominent—linked to altered language, reward, or sensorimotor integration in ASD.</p></li>
</ul>
</li>
<li><p><strong>Increased connectivity in Control (Blue)</strong>:</p>
<ul>
<li><p>Involving <strong>parietal and sensorimotor regions</strong> (<em>Postcentral_R</em>, <em>Precuneus_R</em>, <em>Supramarginal_R</em>), indicating more typical integration of sensory and motor pathways.</p></li>
<li><p>Also includes <strong>default mode and association regions</strong> (<em>Angular_L</em>, <em>Parietal_Inf_R</em>), which are often underconnected in ASD.</p></li>
</ul>
</li>
</ul>
<p>The model distinguishes ASD from Control subjects by identifying <strong>abnormal functional connections</strong>, especially across <strong>frontal–limbic</strong>, <strong>temporal–subcortical</strong>, and <strong>parietal–sensorimotor networks</strong>, aligning with known neurodevelopmental differences in autism.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./tutorials"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../workshops/ukomain2025/preparation.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Preparation</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Reducing Phenotypic Effects to Improve Multi-site Autism Classification Performance</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#packages">Packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions">Helper Functions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-extraction">Feature Extraction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#trainer">Trainer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluation">Evaluation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization">Visualization</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pipeline">Pipeline</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resting-state-fmri-preprocessing">Resting-state fMRI Preprocessing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#phenotype-preprocessing">Phenotype Preprocessing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Feature Extraction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modeling">Modeling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-seed">Random Seed</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-validation-split">Cross-Validation Split</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-definition">Model Definition</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-and-cross-validation">Training and Cross-Validation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Evaluation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpretation">Interpretation</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By PyKale Contributors
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>